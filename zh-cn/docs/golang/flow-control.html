<!DOCTYPE html>
<html lang="en">

<head>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-163094446-1"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'UA-163094446-1');
	</script>
	<meta name="aes-config" content="pid=xux-opensource&user_type=101&uid=&username=&dim10=Sentinel" />
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="flow-control,Sentinel" />
	<meta name="description" content="flow-control" />
	<!-- 网页标签标题 -->
	<title>flow-control | Sentinel</title>
	<link rel="shortcut icon" href="/img/sentinel.ico"/>
	<link rel="stylesheet" href="/build/documentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/zh-cn/index.html"><img class="logo" src="/img/sentinel_colorful.png"/></a><div class="search search-normal"><span class="icon-search"></span></div><span class="language-switch language-switch-normal">En</span><div class="header-menu"><img class="header-menu-toggle" src="/img/system/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><span><a href="/zh-cn/index.html">首页</a></span></li><li class="menu-item menu-item-normal menu-item-normal-active"><span><a href="/zh-cn/docs/introduction.html">文档</a></span></li><li class="menu-item menu-item-normal"><div class="nav-container"><div class="word"><a>解决方案</a><img class="menu-img" src="https://img.alicdn.com/tfs/TB1esl_m.T1gK0jSZFrXXcNCXXa-200-200.png"/></div><ul class="sub-nav-container" style="width:220px"><li><a href="https://www.aliyun.com/product/aliware/mse?sentinel-website.topbar.0.0.0" target="_blank">微服务解决方案</a></li><li><a href="https://www.aliyun.com/product/ahas?spm=sentinel-website.topbar.0.0.0" target="_blank">高可用解决方案</a></li><li><a href="https://www.aliyun.com/aliware/txc?sentinel-website.topbar.0.0.0" target="_blank">分布式事务解决方案</a></li><li><a href="https://cn.aliyun.com/product/aliware/sae?sentinel-website.topbar.0.0.0" target="_blank">微服务Serverless解决方案</a></li><li><a href="https://www.aliyun.com/product/edas?sentinel-website.topbar.0.0.0" target="_blank">APaaS解决方案</a></li><li><a href="https://www.aliyun.com/product/servicemesh?sentinel-website.topbar.0.0.0" target="_blank">服务网格解决方案</a></li></ul> </div></li><li class="menu-item menu-item-normal"><span><a href="/zh-cn/docs/developers/developers_dev.html">开发者</a></span></li><li class="menu-item menu-item-normal"><span><a href="/zh-cn/blog/index.html">博客</a></span></li><li class="menu-item menu-item-normal"><span><a href="/zh-cn/community/index.html">社区</a></span></li><li class="menu-item menu-item-normal"><span><a href="https://developer.aliyun.com/ebook/7565?spm=sentinel-website.topbar.0.0.0">服务治理白皮书</a><img class="menu-img" src="https://img.alicdn.com/tfs/TB1esl_m.T1gK0jSZFrXXcNCXXa-200-200.png"/></span></li><li class="menu-item menu-item-normal"><span><a href="https://www.aliyun.com/product/aliware/mse?sentinel-website.topbar.0.0.0">企业版 Sentinel</a><img class="menu-img" src="https://img.alicdn.com/tfs/TB1esl_m.T1gK0jSZFrXXcNCXXa-200-200.png"/></span></li></ul></div></div></header><div class="bar"><div class="bar-body"><img src="/img/system/docs.png" class="front-img"/><span>文档</span><img src="/img/system/docs.png" class="back-img"/></div></div><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>用户文档</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/introduction.html" target="_self">Sentinel 介绍</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>入门参考<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/quick-start.html" target="_self">快速开始</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/basic-implementation.html" target="_self">基本原理</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>使用文档<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/basic-api-resource-rule.html" target="_self">基本使用（资源与规则）</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/flow-control.html" target="_self">流量控制</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/circuit-breaking.html" target="_self">熔断降级</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/system-adaptive-protection.html" target="_self">系统自适应保护</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/cluster-flow-control.html" target="_self">集群流量控制</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/api-gateway-flow-control.html" target="_self">网关流量控制</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/parameter-flow-control.html" target="_self">热点参数限流</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/origin-authority-control.html" target="_self">来源访问控制</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/annotation-support.html" target="_self">注解支持</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/dynamic-rule-configuration.html" target="_self">动态规则扩展</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/opensergo-data-source.html" target="_self">OpenSergo 流量治理</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/logs.html" target="_self">日志</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/metrics.html" target="_self">实时监控</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/general-configuration.html" target="_self">启动配置项</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/dashboard.html" target="_self">Sentinel 控制台</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/open-source-framework-integrations.html" target="_self">开源框架适配</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/polyglot-support.html" target="_self">多语言支持</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/faq.html" target="_self">FAQ</a></li></ul></li><li class="menu-item menu-item-level-1"><span>多语言文档</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>Sentinel Go<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/golang/quick-start.html" target="_self">快速开始</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/golang/basic-api-usage.html" target="_self">基本 API 使用指南</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/golang/flow-control.html" target="_self">流量控制</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/golang/circuit-breaking.html" target="_self">熔断降级</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/golang/concurrency-limiting-isolation.html" target="_self">并发隔离控制</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/golang/system-adaptive-protection.html" target="_self">系统自适应保护</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/golang/hotspot-param-flow-control.html" target="_self">热点参数流控</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/golang/open-source-framework-integrations.html" target="_self">开源框架适配</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/golang/dynamic-data-source-usage.html" target="_self">动态规则扩展</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/golang/general-configuration.html" target="_self">通用配置</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/golang/logging.html" target="_self">日志</a></li></ul></li></ul></li><li class="menu-item menu-item-level-1"><span>贡献手册</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/contribution/contribution-guideline.html" target="_self">开源贡献指南</a></li></ul></li></ul></div><div class="doc-content markdown-body"><h1>流量控制 (Sentinel Go)</h1>
<h2>Overview</h2>
<p>流量控制(flow control)，其原理是监控资源(<code>Resource</code>)的统计指标，然后根据 token 计算策略来计算资源的可用 token(也就是阈值)，然后根据流量控制策略对请求进行控制，避免被瞬时的流量高峰冲垮，从而保障应用的高可用性。</p>
<p>Sentinel Go 的流量控制实现代码参考：<a href="https://github.com/alibaba/sentinel-golang/tree/master/core/flow">https://github.com/alibaba/sentinel-golang/tree/master/core/flow</a></p>
<p>Sentinel 通过定义流控规则来实现对 <code>Resource</code> 的流量控制。在 Sentinel 内部会在加载流控规则时候将每个 flow.Rule 都会被转换成流量控制器(TrafficShapingController)。 每个流量控制器实例都会有自己独立的统计结构，这里统计结构是一个滑动窗口。Sentinel 内部会尽可能复用 Resource 级别的全局滑动窗口，如果流控规则的统计设置没法复用Resource的全局统计结构，那么Sentinel会为流量控制器创建一个全新的私有的滑动窗口，然后通过 flow.StandaloneStatSlot 这个统计Slot来维护统计指标。</p>
<h2>流控规则</h2>
<p>流控规则的<a href="https://github.com/alibaba/sentinel-golang/blob/master/core/flow/rule.go">定义</a>如下：</p>
<pre><code class="language-go"><span class="hljs-keyword">type</span> Rule <span class="hljs-keyword">struct</span> {
	<span class="hljs-comment">// ID represents the unique ID of the rule (optional).</span>
	ID <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"id,omitempty"`</span>
	<span class="hljs-comment">// Resource represents the resource name.</span>
	Resource               <span class="hljs-keyword">string</span>                 <span class="hljs-string">`json:"resource"`</span>
	TokenCalculateStrategy TokenCalculateStrategy <span class="hljs-string">`json:"tokenCalculateStrategy"`</span>
	ControlBehavior        ControlBehavior        <span class="hljs-string">`json:"controlBehavior"`</span>
	<span class="hljs-comment">// Threshold means the threshold during StatIntervalInMs</span>
	<span class="hljs-comment">// If StatIntervalInMs is 1000(1 second), Threshold means QPS</span>
	Threshold         <span class="hljs-keyword">float64</span>          <span class="hljs-string">`json:"threshold"`</span>
	RelationStrategy  RelationStrategy <span class="hljs-string">`json:"relationStrategy"`</span>
	RefResource       <span class="hljs-keyword">string</span>           <span class="hljs-string">`json:"refResource"`</span>
	MaxQueueingTimeMs <span class="hljs-keyword">uint32</span>           <span class="hljs-string">`json:"maxQueueingTimeMs"`</span>
	WarmUpPeriodSec   <span class="hljs-keyword">uint32</span>           <span class="hljs-string">`json:"warmUpPeriodSec"`</span>
	WarmUpColdFactor  <span class="hljs-keyword">uint32</span>           <span class="hljs-string">`json:"warmUpColdFactor"`</span>
	<span class="hljs-comment">// StatIntervalInMs indicates the statistic interval and it's the optional setting for flow Rule.</span>
	<span class="hljs-comment">// If user doesn't set StatIntervalInMs, that means using default metric statistic of resource.</span>
	<span class="hljs-comment">// If the StatIntervalInMs user specifies can not reuse the global statistic of resource,</span>
	<span class="hljs-comment">// 		sentinel will generate independent statistic structure for this rule.</span>
	StatIntervalInMs <span class="hljs-keyword">uint32</span> <span class="hljs-string">`json:"statIntervalInMs"`</span>
}
</code></pre>
<p>一条流控规则主要由下面几个因素组成，我们可以组合这些元素来实现不同的限流效果：</p>
<ul>
<li><code>Resource</code>：资源名，即规则的作用目标。</li>
<li><code>TokenCalculateStrategy</code>: 当前流量控制器的Token计算策略。Direct表示直接使用字段 Threshold 作为阈值；WarmUp表示使用预热方式计算Token的阈值。</li>
<li><code>ControlBehavior</code>: 表示流量控制器的控制策略；Reject表示超过阈值直接拒绝，Throttling表示匀速排队。</li>
<li><code>Threshold</code>: 表示流控阈值；如果字段 StatIntervalInMs 是1000(也就是1秒)，那么Threshold就表示QPS，流量控制器也就会依据资源的QPS来做流控。</li>
<li><code>RelationStrategy</code>: 调用关系限流策略，CurrentResource表示使用当前规则的resource做流控；AssociatedResource表示使用关联的resource做流控，关联的resource在字段 <code>RefResource</code> 定义；</li>
<li><code>RefResource</code>: 关联的resource；</li>
<li><code>WarmUpPeriodSec</code>: 预热的时间长度，该字段仅仅对 <code>WarmUp</code> 的TokenCalculateStrategy生效；</li>
<li><code>WarmUpColdFactor</code>: 预热的因子，默认是3，该值的设置会影响预热的速度，该字段仅仅对 <code>WarmUp</code> 的TokenCalculateStrategy生效；</li>
<li><code>MaxQueueingTimeMs</code>: 匀速排队的最大等待时间，该字段仅仅对 <code>Throttling</code> ControlBehavior生效；</li>
<li><code>StatIntervalInMs</code>: 规则对应的流量控制器的独立统计结构的统计周期。如果StatIntervalInMs是1000，也就是统计QPS。</li>
</ul>
<p>这里特别强调一下 <code>StatIntervalInMs</code> 和 <code>Threshold</code> 这两个字段，这两个字段决定了流量控制器的灵敏度。以 Direct + Reject 的流控策略为例，流量控制器的行为就是在 <code>StatIntervalInMs</code> 周期内，允许的最大请求数量是<code>Threshold</code>。比如如果 <code>StatIntervalInMs</code> 是 10000，<code>Threshold</code> 是10000，那么流量控制器的行为就是控制该资源10s内运行最多10000次访问。</p>
<h2>流量控制策略</h2>
<p>Sentinel 的流量控制策略由规则中的 <code>TokenCalculateStrategy</code> 和 <code>ControlBehavior</code> 两个字段决定。<code>TokenCalculateStrategy</code> 表示流量控制器的Token计算方式，目前Sentinel支持两种：</p>
<ol>
<li>Direct表示直接使用规则中的 <code>Threshold</code> 表示当前统计周期内的最大Token数量。</li>
<li>WarmUp表示通过预热的方式计算当前统计周期内的最大Token数量，预热的计算方式会根据规则中的字段 <code>WarmUpPeriodSec</code> 和 <code>WarmUpColdFactor</code> 来决定预热的曲线。</li>
</ol>
<p>WarmUp 方式，即预热/冷启动方式。当系统长期处于低水位的情况下，当流量突然增加时，直接把系统拉升到高水位可能瞬间把系统压垮。通过&quot;冷启动&quot;，让通过的流量缓慢增加，在一定时间内逐渐增加到阈值上限，给冷系统一个预热的时间，避免冷系统被压垮。这块设计和 Java 类似，可以参考<a href="https://github.com/alibaba/Sentinel/wiki/%E9%99%90%E6%B5%81---%E5%86%B7%E5%90%AF%E5%8A%A8">限流-冷启动文档</a></p>
<p>通常冷启动的过程系统允许通过的 QPS 曲线如下图所示：</p>
<p><img src="https://user-images.githubusercontent.com/9434884/68292392-b5b0aa00-00c6-11ea-86e1-ecacff8aab51.png" alt=""></p>
<p>字段 <code>ControlBehavior</code> 表示表示流量控制器的控制行为，目前 Sentinel 支持两种控制行为：</p>
<ol>
<li>Reject：表示如果当前统计周期内，统计结构统计的请求数超过了阈值，就直接拒绝。</li>
<li>Throttling：表示匀速排队的统计策略。它的中心思想是，以固定的间隔时间让请求通过。当请求到来的时候，如果当前请求距离上个通过的请求通过的时间间隔不小于预设值，则让当前请求通过；否则，计算当前请求的预期通过时间，如果该请求的预期通过时间小于规则预设的 timeout 时间，则该请求会等待直到预设时间到来通过（排队等待处理）；若预期的通过时间超出最大排队时长，则直接拒接这个请求。</li>
</ol>
<p>匀速排队方式会严格控制请求通过的间隔时间，也即是让请求以均匀的速度通过，对应的是漏桶算法。该方式的作用如下图所示：
<img src="https://user-images.githubusercontent.com/9434884/68292442-d4af3c00-00c6-11ea-8251-d0977366d9b4.png" alt=""></p>
<p>这种方式主要用于处理间隔性突发的流量，例如消息队列。想象一下这样的场景，在某一秒有大量的请求到来，而接下来的几秒则处于空闲状态，我们希望系统能够在接下来的空闲期间逐渐处理这些请求，而不是在第一秒直接拒绝多余的请求。</p>
<p>以下规则代表每 100ms 最多通过一个请求，多余的请求将会排队等待通过，若排队时队列长度大于 500ms 则直接拒绝：</p>
<pre><code class="language-go">{
	Resource:          <span class="hljs-string">"some-test"</span>,
        TokenCalculateStrategy: flow.Direct,
	ControlBehavior:   flow.Throttling, <span class="hljs-comment">// 流控效果为匀速排队</span>
        Threshold:             <span class="hljs-number">10</span>, <span class="hljs-comment">// 请求的间隔控制在 1000/10=100 ms</span>
	MaxQueueingTimeMs: <span class="hljs-number">500</span>, <span class="hljs-comment">// 最长排队等待时间</span>
}
</code></pre>
<p>上面 Threshold 是 10，Sentinel 默认使用1s作为控制周期，表示1秒内10个请求匀速排队，所以排队时间就是 <code>1000ms/10 = 100ms</code>；</p>
<p>特别地，<code>MaxQueueingTimeMs</code> 设为 0 时代表不允许排队，只控制请求时间间隔，多余的请求将会直接拒绝。</p>
<h2>流量控制器的统计结构</h2>
<p>每个流量控制器实例都会有自己独立的统计结构。流量控制器的统计结构由规则中的 <code>StatIntervalInMs</code> 字段设置，<code>StatIntervalInMs</code>表示统计结构的统计周期。Sentinel 默认会为每个Resource创建一个全局的滑动窗口统计结构，这个全局的统计结构默认是一个间隔为10s,20个格子的滑动窗口，也就是每个统计窗口长度是500ms。</p>
<p>流量控制器实例会尽可能复用这个Resource级别的全局统计结构，复用逻辑原则是：优先复用Resource级别的全局统计结构，如果不可复用，就重新创建一个独立的滑动窗口统计结构(BucketLeapArray)，具体的逻辑细节如下：</p>
<ol>
<li>如果<code>StatIntervalInMs</code>大于全局滑动窗口的间隔(默认10s)，那么将不可复用全局统计结构。Sentinel会给流量控制器创建一个长度是<code>StatIntervalInMs</code>，格子数是1的全新统计结构，这个全新的统计结构由Sentinel内部的<code>StandaloneStatSlot</code>来维护统计。</li>
<li>如果<code>StatIntervalInMs</code>小于全局滑动窗口的窗口长度(默认是500ms), 那么将不可复用全局统计结构。Sentinel会给流量控制器创建一个长度是<code>StatIntervalInMs</code>，格子数是1的全新统计结构，这个全新的统计结构由Sentinel内部的<code>StandaloneStatSlot</code>来维护统计。</li>
<li>如果<code>StatIntervalInMs</code>在集合[全局滑动窗口的窗口长度，全局滑动窗口的间隔]之间，首先需要计算格子数：如果<code>StatIntervalInMs</code>可以被全局滑动窗口的窗口长度(默认是500ms)整除，那么格子数就为 <code>StatIntervalInMs</code>/<code>GlobalStatisticBucketLengthInMs</code>，如果不可整除，格子数是1。然后会调用 <code>core/base/CheckValidityForReuseStatistic</code>函数来判断当前统计结构间隔和格子数是否可以复用全局统计结构。如果可以复用，就会基于resource级别的全局统计结构<code>ResourceNode</code>创建<code>SlidingWindow</code>，SlidingWindow是一个虚拟结构，SlidingWindow只可读，而且读的数据是通过聚合<code>ResourceNode</code>数据得到的。如果不可复用，就使用统计结构间隔和格子数创建全新的滑动窗口(BucketLeapArray)。</li>
</ol>
<p>CheckValidityForReuseStatistic函数参考：<a href="https://github.com/alibaba/sentinel-golang/blob/master/core/base/stat.go">https://github.com/alibaba/sentinel-golang/blob/master/core/base/stat.go#func CheckValidityForReuseStatistic</a></p>
<p>基于规则创建统计结构的逻辑参考：<a href="https://github.com/alibaba/sentinel-golang/blob/master/core/flow/rule_manager.go">https://github.com/alibaba/sentinel-golang/blob/master/core/flow/rule_manager.go#func generateStatFor</a></p>
<h2>常见场景的规则配置</h2>
<h3>基于QPS对某个资源限流</h3>
<p>基于对某个资源访问的QPS来做流控，这个是非常常见的场景。流控规则的配置下面有个sample：</p>
<pre><code class="language-go">{
	Resource:                <span class="hljs-string">"some-test"</span>,
        TokenCalculateStrategy:  flow.Direct,
	ControlBehavior:         flow.Reject,
	Threshold:               <span class="hljs-number">500</span>,
        StatIntervalInMs:        <span class="hljs-number">1000</span>,
}
</code></pre>
<p>上面sample中的5个字段是必填的。其中StatIntervalInMs必须是1000，表示统计周期是1s，那么Threshold所配置的值也就是QPS的阈值。</p>
<h3>基于一定统计间隔时间来控制总的请求数</h3>
<p>这个场景就是想在一定统计周期内控制请求的总量。比如<code>StatIntervalInMs</code>配置10000，<code>Threshold</code>配置10000，这种配置意思就是控制10s内最大请求数是10000。sample:</p>
<pre><code class="language-go">{
	Resource:                <span class="hljs-string">"some-test"</span>,
        TokenCalculateStrategy:  flow.Direct,
	ControlBehavior:         flow.Reject,
	Threshold:               <span class="hljs-number">10000</span>,
        StatIntervalInMs:        <span class="hljs-number">10000</span>,
}
</code></pre>
<p>注意：这种流控配置对于脉冲类型的流量抵抗力很弱，有极大潜在风险压垮系统。比如流量表现形式是10s内请求数最大是9800，实际上流量可能是脉冲形式，比如下图：</p>
<p><img src="https://user-images.githubusercontent.com/9346473/94354820-a907bc80-00b1-11eb-8831-a3f67eda908c.png" alt="脉冲流量"></p>
<p>这种类型的流量，其实在前一秒的QPS达到了4500，很可能直接把系统打挂了。对于这种类型流量除非是抗脉冲场景，一般建议使用毫秒级别的流控。</p>
<p>注意：这种大周期的配置其实也有好处，就是能够做到流量的无损，前提是保证系统能够抗住这种周期内的脉冲流量，当然如果流量曲线在秒级别比较平顺，也就不存在脉冲问题，我们是建议统计周期可以稍微调大。</p>
<h3>毫秒级别流控</h3>
<p>针对一些流量曲在毫秒级别波动非常大的场景(类似于脉冲)，建议<code>StatIntervalInMs</code>的配置在毫秒级别，除非特殊场景，建议配置的值为100ms的倍数，比如100，200这种。这种相当于缩小了统计周期，将QPS的周期缩小了10倍，控制周期降低到了100ms。这种配置能够很好的应对脉冲流量，保障系统稳定性，比如sample:</p>
<pre><code class="language-go">{
	Resource:                <span class="hljs-string">"some-test"</span>,
        TokenCalculateStrategy:  flow.Direct,
	ControlBehavior:         flow.Reject,
	Threshold:               <span class="hljs-number">80</span>,
        StatIntervalInMs:        <span class="hljs-number">100</span>,
}
</code></pre>
<p>上面限制了100ms的阈值是80，实际QPS大概是800。</p>
<p>注意：这种配置也是有缺点的，脉冲流量很大可能造成有损(会拒绝很多流量)。</p>
<h3>脉冲流量无损</h3>
<p>针对前面第三点场景，如果既想控制流量曲线，又想无损，一般做法是通过匀速排队的控制策略，平滑掉流量。</p>
<h3>基于调用关系的流量控制</h3>
<p>Sentinel 支持关联流量控制策略。当两个资源之间具有资源争抢或者依赖关系的时候，这两个资源便具有了关联。比如对数据库同一个字段的读操作和写操作存在争抢，读的速度过高会影响写得速度，写的速度过高会影响读的速度。如果放任读写操作争抢资源，则争抢本身带来的开销会降低整体的吞吐量。可使用关联限流来避免具有关联关系的资源之间过度的争抢。</p>
<h2>流控模块核心接口</h2>
<p>在流控模块（flow）中，Sentinel 会为每条流控规则（<code>flow.Rule</code>）生成相应的流量调配器（<code>TrafficShapingController</code>）。TrafficShapingController 由两部分构成：</p>
<ul>
<li><code>TrafficShapingCalculator</code>: 根据规则的计算策略计算出当前的流量阈值（如部分策略在一段时间内逐步抬升 QPS 阈值）</li>
<li><code>TrafficShapingChecker</code>: 根据阈值执行相应的检查和调配策略，返回 <code>base.TokenResult</code> 指示如何进行调配。</li>
</ul>
<h2>Example</h2>
<ul>
<li><a href="https://github.com/alibaba/sentinel-golang/tree/master/example/flow">Go 流控规则示例</a></li>
</ul>
</div></section><footer class="footer-container"><div class="footer-body"><img src="/img/sentinel_gray.png"/><div class="cols-container"><div class="col col-12"><h3>Disclaimer</h3><p>Sentinel is an open-source project under Apache License 2.0.</p></div><div class="col col-6"><dl><dt>文档</dt><dd><a href="/zh-cn/docs/introduction.html" target="_self">概览</a></dd><dd><a href="/zh-cn/docs/quick-start.html" target="_self">快速开始</a></dd><dd><a href="/zh-cn/docs/contribution/contribution-guideline.html" target="_self">开发者指南</a></dd></dl></div><div class="col col-6"><dl><dt>资源</dt><dd><a href="/zh-cn/blog/index.html" target="_self">博客</a></dd><dd><a href="/zh-cn/community/index.html" target="_self">社区</a></dd></dl></div></div><div class="copyright"><span>Copyright © 2018 - 2022 The Sentinel Authors | An Alibaba Middleware (Aliware) Project</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '';
    </script>
	<script src="/build/documentation.js"></script>
</body>
</html>